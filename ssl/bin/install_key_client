#! /bin/bash

set -eu -o pipefail

script_dir="$(dirname "$(readlink -f "$0")")"
base_dir="$(dirname "$script_dir")"
source "$base_dir/var/paths.sh"

client_name="$(whoami)"
pg_config_dir=${PGDATA-}
pg_config_path=
pg_restart=0
ssl_config_name=ssl-client.conf
cert_users_file_name=ssl-cert_users
cert_users_file_path=$pg_config_dir/$cert_users_file_name

function get_boolean() {
    case "$(echo "$1" | tr '[:upper:]' '[:lower:]')" in
        1|t|true|y|yes)
            echo 1
            return
        ;;
        0|f|false|n|no)
            echo 0
            return
        ;;
    esac
    echo "Value \"$1\" is not a recognized boolean value." >&2
    exit 2
}

parsed_args=$(getopt -o "d:c:r:" -l "datadirectory:,configfile:,restart:" -n "$(basename $0)" -- "$@")

if [ $? -ne 0 ]; then
    exit 1
fi

eval set -- "$parsed_args"

while [[ $# -gt 1 ]]; do
    case "$1" in
        -d|--datadirectory)
            pg_config_dir=$2
            shift
        ;;
        -c|--configfile)
            pg_config_path=$2
            shift
        ;;
        -r|--restart)
            pg_restart=$(get_boolean $2)
            shift
        ;;
        *)
            exit 2
        ;;
    esac
    shift
done

if [ -n "$pg_config_dir" ]; then
    if [ -z "$pg_config_path" ]; then
        if [ -e "$pg_config_dir/postgresql.conf" ]; then
            pg_config_path=$pg_config_dir/postgresql.conf
        fi
    fi
fi

ssl_config_path=${pg_config_dir}/${ssl_config_name}
pg_hba_conf_path="$pg_config_dir/pg_hba.conf"

if [ ! -e "$ca_client_intermediate_dir/openssl/certs/$client_name.cert.pem" ]; then
    echo "Cert \"$ca_client_intermediate_dir/openssl/certs/$client_name.cert.pem\" does not exist." >&2
    exit 2
fi

if [ ! -e "$HOME/.postgresql" ]; then
    mkdir "$HOME/.postgresql"
fi

cp -p "$ca_client_intermediate_dir/openssl/certs/$client_name.cert.pem" "$HOME/.postgresql/postgresql.crt"
cp -p "$ca_client_intermediate_dir/openssl/private/$client_name.key.pem" "$HOME/.postgresql/postgresql.key"
cp -p "$ca_client_intermediate_dir/openssl/certs/ca-chain.cert.pem" "$pg_config_dir/root.crt"
cat "$ca_client_root_dir/openssl/crl/ca.crl.pem" \
    "$ca_client_intermediate_dir/openssl/crl/ca.crl.pem" > "$pg_config_dir/root.crl"

cp "$ca_server_intermediate_dir/openssl/certs/ca-chain.cert.pem" "$HOME/.postgresql/root.crt"
cat "$ca_server_root_dir/openssl/crl/ca.crl.pem" \
    "$ca_server_intermediate_dir/openssl/crl/ca.crl.pem" > "$HOME/.postgresql/postgresql.crl"

cat > "$ssl_config_path" <<EOF
ssl_ca_file = 'root.crt'
ssl_crl_file = 'root.crl'
EOF
echo "Updated $ssl_config_path"

if ! grep -q "include.*=.*${ssl_config_name}" "$pg_config_path"; then
    echo "include = '$ssl_config_name'" >> "$pg_config_path"
    echo "Updated $pg_config_path"
fi

if [ ! -e "$cert_users_file_path" ]; then
    cat >> "$cert_users_file_path" <<EOF
# This file lists PostgreSQL users who have certificates generated by a set of scripts.
# This file is updated by certificate generation scripts.
# Put each PostgreSQL user name on its own line.  Do not add leading or trailing spaces or tabs.
# This file can be referenced in pg_hba.conf so that users with certificates can use a dedicated HBA rule.

${client_name}
EOF
    echo "Created $cert_users_file_path"
else
    if ! grep -q "^${client_name}\$" "$cert_users_file_path"; then
        echo "${client_name}" >> "$cert_users_file_path"
        echo "Updated $cert_users_file_path"
    fi
fi

if ! grep -q ".*host.*${cert_users_file_name}.*cert.*" "$pg_hba_conf_path"; then
    crtusrsfiln=$cert_users_file_name
# TYPE  DATABASE        USER            ADDRESS                 METHOD
    cat >> "$pg_hba_conf_path" <<EOF
#hostssl all             @${crtusrsfiln} ::1/128                 cert clientcert=1
#hostssl all             @${crtusrsfiln} 0.0.0.0/0               cert clientcert=1
EOF
    echo "Updated $pg_hba_conf_path"
    echo
    echo "EDIT $pg_hba_conf_path AND UNCOMMENT THE BOTTOM 2 hostssl LINES AND"
    echo "MOVE THEM ABOVE ALL OTHER host LINES."
    echo
fi

# For PostgreSQL 10 or above, change this to reload.
if [ $pg_restart -ne 0 ]; then
    echo -n "PostgreSQL "; pg_ctl restart
else
    echo 'You need to run "pg_ctl restart" to make these changes effective.'
fi
