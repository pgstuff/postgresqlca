#! /bin/bash

set -eu -o pipefail

script_dir="$(dirname "$(readlink -f "$0")")"
base_dir="$(dirname "$script_dir")"

server_host_name="$1"

function load_vars() {
    local var_path="$base_dir/var"

    cert_days="$(cat "$var_path/server_cert_days.var")"
    message_digest="$(cat "$var_path/server_message_digest.var")"
}

if [ -e "$base_dir/openssl/certs/$server_host_name.cert.pem" ]; then
    echo "The cert (\"$base_dir/openssl/certs/$server_host_name.cert.pem\") exists." >&2
    exit 2
fi

load_vars

"$base_dir/bin/openssl_gen_cnf"

openssl ca -config "$base_dir/tmp/openssl.cnf" -extensions server_cert \
    -days "$cert_days" -notext -md "$message_digest" \
    -passin fd:3 -batch \
    -in "$base_dir/openssl/csr/$server_host_name.csr.pem" \
    -out "$base_dir/openssl/certs/$server_host_name.cert.pem"

chmod 644 "$base_dir/openssl/certs/$server_host_name.cert.pem"

#openssl x509 -noout -text -in "$base_dir/openssl/certs/$server_host_name.cert.pem"

openssl verify -CAfile "$base_dir/openssl/certs/ca-chain.cert.pem" \
      "$base_dir/openssl/certs/$server_host_name.cert.pem"
